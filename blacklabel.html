<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="blacklabel.css">
</head>

<div class="sheet-container">
    <!--MECHANICS SECTION: 
        1. Add mechanics (HP, Speed, Shield (ft and ti), BP)
        2. Find a way to connect the stats to the token
    -->

        <div class="sheet-section-mechanics sheet-section sheet-quarter">

            <div class="sheet-row" style="padding-left: 5px;">

                <div class="mechanics-container">

                    <img src="hp.png" alt="hp" style="width:150px; height: 150px;">

                    <input type="number" name="attr_hp" value="0"/>

                    <div class="circle">
                        <input type="number" name="attr_hp" value="0"/>
                    </div>

                <div class="mechanics-container">

                    <img src="shield.png" alt="shield" style="width:150px; height: 150px">

                    <input type="number" name="attr_hp" value="0" style="left: 59px"/>

                    <div class="circle">
                        <input type="number" name="attr_hp" value="0"/>
                    </div>

                </div>

                <div class="mechanics-container" >

                    <img src="bp.png" alt="bp" style="width:150px; height: 150px;">

                    <input type="number" name="attr_hp" value="0"/>

                    <div class="circle">
                        <input type="number" name="attr_hp" value="0"/>
                    </div>
                </div>
            
            </div>

        </div>

    </div>

    <!--ID SECTION: DONE -->
        <div class="sheet-section-id sheet-section three-quarters">
            
            <div class="sheet-header">
                <span>ID</span>
            </div>
            <input class="sheet-level-flag sheet-hidden" type="checkbox" name="attr_show_fatepoints_flag" value="1" checked />
            <div class="sheet-section sheet-section-id-info">
                <div class="sheet-repitem">
                    <input type="text" name="attr_character_name" placeholder="Name" />
                </div>

                <div class="sheet-row">
                    <input type="text" name="attr_character_past" placeholder="Past" style="width:45%"/>
                    <input type="text" name="attr_character_discipline" placeholder="Discipline" style="width:50%"/>
                </div>
                
                <div class="sheet-repitem">
                    <textarea name="attr_character_description" placeholder="Description"></textarea>
                </div>
            </div>

            <div class="sheet-section sheet-section-id-level">
                <div class="sheet-repitem">
                    <label style="font-size: smaller;">Level</label>
                    <input type="number" name="attr_level_refresh" placeholder="0" />
                </div>
            </div>
        </div>

     <!--SKILLS SECTION: 
        1. Add role dice for each skill (same dice, different modifiers)
        2. Add advantage/disadvantage
    -->
        <div class="sheet-section-skills sheet-section sheet-half">
            <div class="sheet-header">
                <span>Stats and Skills</span>
            </div>

            <div class="sheet-row" style="padding-top:10px">

                <div class="sheet-col">
                        
                    <div class="stat-header" style="padding-left: 45px">
                        <label>Body (<input type="number" name="stat_body" value="0"/>)</label>
                    </div>

                    <div class="container-skill">
                            
                        <button type="roll" class="sheet-action-button" name="roll_ladder" value="&{template:skill} @{rollTemplate_showCharName}  {{shiftLevelText=Strength}} {{skill=@{ladderRollLabel}}} {{skillRoll=[[2df + 8]]}}">
                            <span>Strength</span>
                        </button>
                        <input type="number" name="skill_str" value="0" />
                        <label>Will</label>
                        <input type="number" name="skill_wil" value="0" />
                        <label>Vigor</label>
                        <input type="number" name="skill_vig" value="0" />

                    </div>

                </div>

                <div class="sheet-col">

                    <div class="stat-header" style="padding-left: 25px">
                        <label>Technique (<input type="number" name="stat_tech" value="0"/>)</label>
                    </div>

                    <div class="container-skill">
                        <label>Acrobratics</label>
                        <input type="number" name="skill_acr" value="0" />
                        <label>Finesse</label>
                        <input type="number" name="skill_fin" value="0" />
                        <label>Control</label>
                        <input type="number" name="skill_cont" value="0" />
                    </div>

                </div>

                <div class="sheet-col">

                    <div class="stat-header" style="padding-left: 30px">
                        <label>Presence (<input type="number" name="stat_pres" value="0" />)</label>
                    </div>

                    <div class="container-skill">
                        
                        <label>Rapport</label>
                        <input type="number" name="skill_rap" value="0" />
                        <label>Menace</label>
                        <input type="number" name="skill_men" value="0" />
                        <label>Convince</label>
                        <input type="number" name="skill_con" value="0" />
                    </div>
                </div>

                <div class="sheet-col col-wrap">

                    <div class="stat-header" style="padding-left: 45px">
                        <label>Mind (<input type="number" name="stat_mind" value="0"/>)</label>
                    </div>
                    
                    <div class="container-skill">

                        <label>Empathy</label>
                        <input type="number" name="skill_emp" value="0" />
                        <label>Lore</label>
                        <input type="number" name="skill_lore" value="0" />
                        <label>Insight</label>
                        <input type="number" name="skill_ins" value="0" />
                    </div>
                </div>

            </div>
    
        </div>

    <!--MECHANICS 2 SECTION: 
        1. Add speed (ft and time), proficiency
        2. Maybe actions, bonus and movement
    -->
        <div class="sheet-section-mechanics2 sheet-section sheet-quarter">
            <div class="sheet-header">
                <span>ID</span>
            </div>
        </div>

        <div class="sheet-break"></div>

    <!--BONUSES SECTION: DONE-->
        <div class="sheet-section-bonuses sheet-section sheet-half">
            <div class="sheet-header">
                <span>Bonuses and Stunts</span>
            </div>
            <fieldset class="repeating_bonuses">
                <div class="sheet-item-options">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                    <div class="sheet-display">
                        <input class="sheet-item-options-flag2" type="checkbox" name="attr_more_flag" checked="checked" />
                        <span>E</span>
                    </div>
                    <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <input type="text" name="attr_bonusname" placeholder="Name" />
                    <textarea name="attr_bonusdesc" placeholder="Description"></textarea>
                </div>
                <div class="sheet-display">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_more_flag" checked="checked" />
                    <div class="sheet-display">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button" name="roll_bonuses" value="&{template:bonuses} {{bonuses=@{bonusname}}} {{description=@{bonusdesc}}}">
                                <span name="attr_bonusname"></span>
                            </button>
                        </h3>
                        
                        <span name="attr_bonusdesc" class="sheet-keep-whitespace"> </span>
                    </div>
                    <div class="sheet-options">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button sheet-tooltip" name="roll_bonuses" value="&{template:bonuses} {{bonuses=@{bonusname}}} {{description=@{bonusdesc}}}">
                                <span name="attr_bonusname"></span>
                                <span name="attr_bonusdesc" class="sheet-tooltipText sheet-keep-whitespace"></span>
                            </button>
                        </h3>
                    </div>
                </div>
            </fieldset>
        </div>

    <!--KEYWORDS SECTION: DONE-->
        <div class="sheet-section-keywords sheet-section sheet-half">
            <div class="sheet-header">
                <span>Keywords</span>
            </div>
            <fieldset class="repeating_keywords">
                <div class="sheet-item-options">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                    <div class="sheet-display">
                        <input class="sheet-item-options-flag2" type="checkbox" name="attr_more_flag" checked="checked" />
                        <span>E</span>
                    </div>
                    <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <input type="text" name="attr_keyname" placeholder="Name" />
                    <input type="text" name="attr_keysource" placeholder="Source" />
                    <textarea name="attr_keydesc" placeholder="Description"></textarea>
                </div>
                <div class="sheet-display">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_more_flag" checked="checked" />
                    <div class="sheet-display">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button" name="roll_keywords" value="&{template:keywords} {{keyword=@{keyname}}} {{source=@{keysource}}} {{description=@{keydesc}}}">
                                <span name="attr_keyname"></span>
                            </button>
                        </h3>

                        <div class="row">
                            <span class="sheet-inlineLabel">Source</span>
                            <span class="sheet-inlineLabel">: </span>
                            <span name="attr_keysource"></span>
                        </div>   
                        
                        <span name="attr_keydesc" class="sheet-keep-whitespace"> </span>
                    </div>
                    <div class="sheet-options">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button sheet-tooltip" name="roll_keywords" value="&{template:keywords} {{keyword=@{keyname}}} {{source=@{keysource}}} {{description=@{keydesc}}}">
                                <span name="attr_keyname"></span>
                                <span name="attr_keysource"></span>
                                <span name="attr_keydesc" class="sheet-tooltipText sheet-keep-whitespace"></span>
                            </button>
                        </h3>
                    </div>
                </div>
            </fieldset>
        </div>

        <div class="sheet-break"></div>

    <!--STRESS SECTION: 
        1. Make it so that stress and sanity are default to 4 and does not show up as the edit view in default
        2. Make Enlightenment a simple input scroller 
    -->
        <div class="sheet-section-stress sheet-section sheet-half">
            <div class="sheet-header">
                <span>Status</span>
                <div class="sheet-section-options">
                    <button type="action" name="act_clearStress" >
                        <span>#</span>
                    </button>
                </div>
            </div>
            <fieldset class="repeating_stress">
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <input type="text" name="attr_name" placeholder="Name" />
                    <select name="attr_usable">
                        <option value=1>1</option>
                        <option value=2>2</option>
                        <option value=3>3</option>
                        <option value=4 selected>4</option>
                        <option value=5>5</option>
                        <option value=6>6</option>
                        <option value=7>7</option>
                        <option value=8>8</option>
                    </select>
                    <input type="hidden" name="attr_bound" />
                    <div class="sheet-item-options sheet-stress-edit">
                        <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                        <span>3</span>
                    </div>
                </div>
                <div class="sheet-display">
                    <div class="sheet-stress-header">
                        <span class="sheet-stress-header-name" name="attr_name"></span>
                        <span class="sheet-stress-header-skill" name="attr_skill"></span>
                    </div>
                    <div class="sheet-stress-row">
                        <input type="hidden" name="attr_usable" />
                        <input type="checkbox" name="attr_isUsed1" title="1" value=1 />
                        <input type="checkbox" name="attr_isUsed2" title="2" value=2 />
                        <input type="checkbox" name="attr_isUsed3" title="3" value=3 />
                        <input type="checkbox" name="attr_isUsed4" title="4" value=4 />
                        <input type="checkbox" name="attr_isUsed5" title="5" value=5 />
                        <input type="checkbox" name="attr_isUsed6" title="6" value=6 />
                        <input type="checkbox" name="attr_isUsed7" title="7" value=7 />
                        <input type="checkbox" name="attr_isUsed8" title="8" value=8 />
                    </div>
                </div>
            </fieldset>
        </div>

    <!--CONDITIONS SECTION: DONE-->
        <input class="sheet-conditions-flag sheet-hidden" type="checkbox" name="attr_show_conditions_flag" value="1" />

        <div class="sheet-section-consequences sheet-section sheet-half">
            <div class="sheet-header">
                <span>Conditions</span>
            </div>
            <div class="sheet-repitem sheet-consequence-row">
                <span class="sheet-consequence-worth"></span>
            </div>
            <fieldset class="repeating_consequences">
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <select name="attr_worth">
                        <option value=2 selected><span>Mild</span> (2)</option>
                        <option value=4><span>Moderate</span> (4)</option>
                        <option value=6><span>Severe</span> (6)</option>
                        <option value=8><span>Extreme</span> (8)</option>
                    </select>
                    <input type="hidden" name="attr_worth_text" value="Mild"/>
                    <input type="checkbox" name="attr_isUsed" class="sheet-hidden" value="1" />
                    <div class="sheet-item-options sheet-consequence-edit">
                        <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                        <span>3</span>
                    </div>
                </div>
                <div class="sheet-display sheet-consequence-row">
                    <div class="sheet-consequence-worth">
                            <span class="sheet-worth-value" name="attr_worth"></span>
                            <span class="sheet-worth-text" name="attr_worth_text"></span>
                    </div>
                    <input type="text" name="attr_aspect" class="sheet-consequence-aspect" />/>
                </div>
            </fieldset>
        </div>
        <div class="sheet-section-conditions sheet-section sheet-half">
            <div class="sheet-header">
                <span>Conditions</span>
                <div class="sheet-section-options">
                    <input class="sheet-section-options-flag" type="checkbox" name="attr_consequences_options_flag" checked="checked" />
                    <span>p</span>
                </div>
            </div>
            <div class="sheet-repitem sheet-conditions-row">
                <span class="sheet-consequence-worth"></span>
            </div>
            <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_consequences_options_flag" checked="checked" />
            <div class="sheet-options">
                <fieldset class="repeating_consequences">
                    <div class="sheet-conditions-row">
                        <select name="attr_worth">
                            <option value=1 selected><span>Fleeting</span> (1)</option>
                            <option value=2><span>Sticky</span> (2)</option>
                            <option value=4><span>Lasting</span> (4)</option>
                        </select>
                        <input type="hidden" name="attr_worth_text" value="Fleeting"/>
                        <input type="text" name="attr_aspect" placeholder="Aspect" />
                        <input type="checkbox" name="attr_isUsed" class="sheet-hidden" value="1" />
                        <input type="checkbox" name="attr_isHealing" class="sheet-hidden" value="1" />
                    </div>
                </fieldset>
            </div>
            <div class="sheet-display">
                <div class="sheet-conditions-group1">
                    <h3><span>Fleeting</span></h3>
                    <fieldset class="repeating_consequences">
                        <input type="hidden" name="attr_worth" class="sheet-conditions-filter" />
                        <input type="hidden" name="attr_worth_text" />
                        <div class="sheet-conditions-row">
                            <div class="sheet-consequence-worth">
                                <span class="sheet-worth-value" name="attr_worth"></span>
                                <input type="checkbox" name="attr_isUsed" value="1" />
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="sheet-conditions-group2">
                    <h3><span>Sticky</span></h3>
                    <fieldset class="repeating_consequences">
                        <input type="hidden" name="attr_worth" class="sheet-conditions-filter" />
                        <input type="hidden" name="attr_worth_text" />
                        <div class="sheet-conditions-row">
                            <div class="sheet-consequence-worth">
                                <span class="sheet-worth-value" name="attr_worth"></span>
                                <input type="checkbox" name="attr_isUsed" value="1" />
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="sheet-conditions-group4">
                    <h3><span>Lasting</span></h3>
                    <fieldset class="repeating_consequences">
                        <input type="hidden" name="attr_worth" class="sheet-conditions-filter" />
                        <input type="hidden" name="attr_worth_text" />
                        <div class="sheet-conditions-row">
                            <div class="sheet-consequence-worth">
                                <span class="sheet-worth-value" name="attr_worth"></span>
                                <input type="checkbox" name="attr_isUsed" value="1" />
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>

        <div class="sheet-break"></div>
    
    <!--INVENTORY SECTION:
        1. Add 4 different currencies
        2. Repeatable items (qty, name, description)
    -->


    
    <!--WEAPONS SECTION:
        1. Primary and Secondary weapons (name, trait/range, type, feature, damage dice)
        2. Add rolls to hit and to damage 
    -->

    <!--NOTES SECTION:
        1. Make a part of the sheet instead of an individual tab
   
        <input class="sheet-notesTab-flag sheet-hidden" type="checkbox" name="attr_show_notesTab_flag" value="1" />
 -->
        <!--
        <div class="sheet-section-notes sheet-section">
            <div class="sheet-header">
                <span>NOTES</span>
            </div>
            <fieldset class="repeating_notes">
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-item-options sheet-notes-edit">
                    <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
                <div class="sheet-options sheet-notes-row">
                    <input type="text" name="attr_title" placeholder="Notes Title" />
                    <textarea name="attr_body" placeholder="Notes"></textarea>
                </div>
                <div class="sheet-display sheet-notes-row">
                    <h3><span name="attr_title"></span></h3>
                    <span name="attr_body" class="sheet-keep-whitespace"></span>
                </div>
            </fieldset>
        </div>
    </div>
    
    <div class="sheet-tab-content sheet-tab3">
        <h1>Notes</h1>
        <fieldset class="repeating_notes">
            <div class="sheet-header">
                <span name="attr_title"></span>
                <div class="sheet-section-options">
                    <input class="sheet-section-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
            </div>
            <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
            <div class="sheet-options">
                <input type="text" name="attr_title" placeholder="Notes Title" />
                <textarea name="attr_body" placeholder="Notes"></textarea>
            </div>
            <div class="sheet-display">
                <span name="attr_body" class="sheet-keep-whitespace"></span>
            </div>
        </fieldset>
    </div>
    
    <div class="sheet-tab-content sheet-tab4">
        <h1>Settings</h1>

        <div class="sheet-section">
            <div class="sheet-header">
                <span>Display Options</span>
            </div>
        </div>

        
        <div class="sheet-section">
            <div class="sheet-header">
                <span>Game Defaults</span>
            </div>
            <div class="sheet-settings">
                <div class="sheet-setting">
                    <div class="sheet-header">
                        <span>Run First Time Setup</span>
                    </div>
                    <div>
                        <input type="checkbox" value="1" name="attr_run_firstTime_setup" checked="checked" />
                        <p><span>Run scripts to setup the sheet for a default character.</span></p>
                    </div>
                </div>
                <div class="sheet-setting">
                    <div class="sheet-header">
                        <span>Default Status</span>
                    </div>
                    <div>
                        <input type="text" value="Stress,Sanity,Enlightenment" name="attr_default_stressSkills" />
                        <p><span>When setting up a default sheet, what stress tracks and their guiding skill should be set up? e.g. "Mental:Will,Extra:3"</span></p>
                    </div>
                </div>
                <div class="sheet-setting">
                    <div class="sheet-header">
                        <span>Default Consequences</span>
                    </div>
                    <div>
                        <input type="text" value="2,4,6" name="attr_default_consequences" />
                        <p><span>When setting up a default sheet, what consequences are the default consequences? e.g. "2,4,6"</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
-->

<!--BONUS ROLL SECTION: DONE
<rolltemplate class="sheet-rolltemplate-bonuses">
    <div class="sheet-rollTemplate">
        <div class="row sheet-header">
            <span>Bonuses and Stunts</span>
            <span>: </span>
            <span>{{bonuses}}</span>
        </div>
        <div class="row">
            <span>{{description}}</span>
        </div>
    </div>
</rolltemplate>
-->

<!--KEYWORD ROLL SECTION: DONE
<rolltemplate class="sheet-rolltemplate-keywords">
    <div class="sheet-rollTemplate">
        <div class="row sheet-header">
            <span>Keyword</span>
            <span>: </span>
            <span>{{keyword}}</span>
        </div>
        <div class="row">
            <span class="sheet-inlineLabel">Source</span>
            <span class="sheet-inlineLabel">: </span>
            <span>{{source}}</span>
        </div>
        <div class="row">
            <span>{{description}}</span>
        </div>
    </div>
</rolltemplate>
-->

<!--SKILL ROLL SECTION:
    1. Make 2 similar columns to emulate advantage/disadvantage
    2. Implement rolls + modifier

<rolltemplate class="sheet-rolltemplate-skill">
    <div class="sheet-rollTemplate">
        <div class="row sheet-header">
            <span>{{skill}}</span>
        </div>
        <div class="sheet-col">
            <div class="row">
                <label>Boon</label>
                <label>Dread</label>
                <label>Result</label>
            </div>
            <div class="sheet-row">
                <label>Boon</label>
                <label>Dread</label>
                <label>Result</label>
            </div>
        </div>
    </div>
</rolltemplate>
-->
    
<script type="text/worker">
    on('sheet:opened', function () {
        getAttrs(["run_firstTime_setup", "default_stressSkills",
                    "default_consequences", "show_conditions_flag",
                    "importedOldData_flag"], function (values) {
            if (isNullOrWhitespace(values["importedOldData_flag"]))
            {
                ImportIdData();
                ImportSkills();
                ImportAspects();
                ImportStunts();
                ImportExtras();
                ImportStresses(values["run_firstTime_setup"], values["default_stressSkills"]);
                ImportConsequences(values["run_firstTime_setup"],
                    values["default_consequences"],
                    values["show_conditions_flag"]);
                ImportNotes();
    
                setAttrs({ importedOldData_flag: 1, run_firstTime_setup: 0 });
                return;
            }
            if (!isNullOrWhitespace(values["run_firstTime_setup"])) {
                SetDefaultStress(values["default_stressSkills"]);
                SetDefaultConsequences(values["default_consequences"], values["show_conditions_flag"]);
    
                setAttrs({ run_firstTime_setup: 0 });
            }
        });
    });
    
    function ImportIdData () {
        getAttrs(["Description", "Refresh", "Fate"], function (values) {
            if(isNullOrWhitespace(values["Description"])
                && isNullOrWhitespace(values["Refresh"]
                && isNullOrWhitespace(values["Fate"])))
                return;
    
            setAttrs({ character_description: values["Description"],
                        fatePoints_refresh: Number(values["Refresh"]),
                        fatepoints: Number(values["Fate"])
                     });
        });
    };
    
    function ImportSkills () {
        getAttrs(["LegendaryActive", "EpicActive", "FantasticActive",
                    "SuperbActive", "PoorActive", "TerribleActive"], settings => {
            var attrs = [];
            for (var i = 1; i < 9; i++) {
                if (!isNullOrWhitespace(settings["LegendaryActive"]) || typeof settings["LegendaryActive"] === "undefined")
                    attrs.push("Leg" + i);
                if (!isNullOrWhitespace(settings["EpicActive"]) || typeof settings["LegendaryActive"] === "undefined")
                    attrs.push("Epic" + i);
                if (!isNullOrWhitespace(settings["FantasticActive"]) || typeof settings["LegendaryActive"] === "undefined")
                    attrs.push("Fan" + i);
                if (!isNullOrWhitespace(settings["SuperbActive"]) || typeof settings["LegendaryActive"] === "undefined")
                    attrs.push("Sup" + i);
                attrs.push("Great" + i);
                attrs.push("Good" + i);
                attrs.push("Fair" + i);
                attrs.push("Avg" + i);
                if (!isNullOrWhitespace(settings["PoorActive"]) || typeof settings["LegendaryActive"] === "undefined")
                    attrs.push("Poor" + i);
                if (!isNullOrWhitespace(settings["TerribleActive"]) || typeof settings["LegendaryActive"] === "undefined")
                    attrs.push("Ter" + i);
            }
    
            getAttrs(attrs, function (values) {
                for (var i = 1; i < 9; i++) {
                    if (!isNullOrWhitespace(settings["LegendaryActive"]) || typeof settings["LegendaryActive"] === "undefined")
                        importSkill(values["Leg" + i], 8);
                    if (!isNullOrWhitespace(settings["EpicActive"]) || typeof settings["LegendaryActive"] === "undefined")
                        importSkill(values["Epic" + i], 7);
                    if (!isNullOrWhitespace(settings["FantasticActive"]) || typeof settings["LegendaryActive"] === "undefined")
                        importSkill(values["Fan" + i], 6);
                    if (!isNullOrWhitespace(settings["SuperbActive"]) || typeof settings["LegendaryActive"] === "undefined")
                        importSkill(values["Sup" + i], 5);
                    importSkill(values["Great" + i], 4);
                    importSkill(values["Good" + i], 3);
                    importSkill(values["Fair" + i], 2);
                    importSkill(values["Avg" + i], 1);
                    if (!isNullOrWhitespace(settings["PoorActive"]) || typeof settings["LegendaryActive"] === "undefined")
                        importSkill(values["Poor" + i], -1);
                    if (!isNullOrWhitespace(settings["TerribleActive"]) || typeof settings["LegendaryActive"] === "undefined")
                        importSkill(values["Ter" + i], -2);
                }
            });
        });
    };
    
    const importSkill = (skill, skillLevel) => {
        if (isNullOrWhitespace(skill))
            return;
    
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_skills_" + newRowId + "_skill"] = skill;
        newRowAttrs["repeating_skills_" + newRowId + "_shiftLevel"] = skillLevel;
        newRowAttrs["repeating_skills_" + newRowId + "_shiftLevelText"] = getShiftText(skillLevel);
        setAttrs(newRowAttrs);
    };
    
    function ImportAspects () {
        var attrs = [];
        attrs.push("HighConcept");
        attrs.push("Trouble");
        attrs.push("AdvantagesActive");
        for (var i = 1; i < 6; i++) {
            attrs.push("HiCon" + i);
            attrs.push("Trouble" + i);
        }
    
        getAttrs(attrs, function (values) {
            var hiCon = 0;
            var trbl = 0;
            for (var i = 1; i < 6; i++) {
                if (!isNullOrWhitespace(values["HiCon" + i]))
                    hiCon++;
                if (!isNullOrWhitespace(values["Trouble" + i]))
                    trbl++;
            }
    
            if (hiCon > 0)
                importSitAspect(values["HighConcept"], hiCon);
            if (trbl > 0)
                importSitAspect(values["Trouble"], trbl);
    
            if (isNullOrWhitespace(values["AdvantagesActive"]))
                return;
    
            getSectionIDs("repeating_Advantages", function (idArray) {
                if (idArray.length == 0)
                    return;
        
                idArray.forEach(id => {
                    var attrs = [];
                    attrs.push("repeating_Advantages_" + id + "_Advantages");
                    for (var i = 1; i < 6; i++) {
                        attrs.push("repeating_Advantages_" + id + "_Adv" + i);
                    }
        
                    getAttrs(attrs, function (values) {
                        var bonus = 0;
                        for (var i = 1; i < 6; i++) {
                            if (!isNullOrWhitespace(values["repeating_Advantages_" + id + "_Adv" + i]))
                                bonus++;
                        }
                
                        importSitAspect(values["repeating_Advantages_" + id + "_Advantages"], bonus);
                        removeRepeatingRow("repeating_Advantages_" + id);
                    });
                });
            });
        });
    
        getSectionIDs("repeating_Aspects", function (idArray) {
            if (idArray.length == 0)
                return;
    
            idArray.forEach(id => {
                var attrs = [];
                attrs.push("repeating_Aspects_" + id + "_Aspect");
                for (var i = 1; i < 6; i++) {
                    attrs.push("repeating_Aspects_" + id + "_Asp" + i);
                }
    
                getAttrs(attrs, function (values) {
                    var bonus = 0;
                    for (var i = 1; i < 6; i++) {
                        if (!isNullOrWhitespace(values["repeating_Aspects_" + id + "_Asp" + i]))
                            bonus++;
                    }
            
                    var index = idArray.indexOf(id);
                    if (index < 3) {
                        if (index == 0)
                            setAttrs({ aspect_one: values["repeating_Aspects_" + id + "_Aspect"]});
                        else if (index == 1)
                            setAttrs({ aspect_two: values["repeating_Aspects_" + id + "_Aspect"]});
                        else if (index == 2)
                            setAttrs({ aspect_three: values["repeating_Aspects_" + id + "_Aspect"]});
                        if (bonus > 0)
                            importSitAspect(values["repeating_Aspects_" + id + "_Aspect"], bonus);
                    }
                    else
                        importSitAspect(values["repeating_Aspects_" + id + "_Aspect"], bonus);
    
                    removeRepeatingRow("repeating_Aspects_" + id);
                });
            });
        });
    };
    
    const importSitAspect = (aspect, bonus) => {
        if (isNullOrWhitespace(aspect))
            return;
    
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_situationaspect_" + newRowId + "_aspect_name"] = aspect;
        newRowAttrs["repeating_situationaspect_" + newRowId + "_aspect_free_invokes"] = bonus;
        newRowAttrs["repeating_situationaspect_" + newRowId + "_options_flag"] = "on";
        setAttrs(newRowAttrs);
    };
    
    function ImportStunts () {
        getAttrs(["Stunts"], function (values) {
            getSectionIDs("repeating_Stunts", function (idArray) {
                importStunt(values["Stunts"]);
    
                if (idArray.length == 0)
                    return;
        
                var attrs = [];
                for (var i = 0; i < idArray.length; i++) {
                    attrs.push("repeating_Stunts_" + idArray[i] + "_Stunt");
                }
        
                getAttrs(attrs, function (stunts) {
                    for (var i = 0; i < idArray.length; i++) {
                        importStunt(stunts["repeating_Stunts_" + idArray[i] + "_Stunt"]);
                        removeRepeatingRow("repeating_Stunts_" + idArray[i]);
                    }
        
                    setAttrs(newRowAttrs);
                });
            });        
        });
    };
    
    const importStunt = (stunt) => {
        if (isNullOrWhitespace(stunt))
            return;
    
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_stunts_" + newRowId + "_description"] = stunt;
        setAttrs(newRowAttrs);
    };
    
    function ImportExtras () {
        getAttrs(["Extras"], function (values) {
            getSectionIDs("repeating_Extras", function (idArray) {
                importExtra(values["Extras"]);
    
                if (idArray.length == 0)
                    return;
        
                var attrs = [];
                for (var i = 0; i < idArray.length; i++) {
                    attrs.push("repeating_Extras_" + idArray[i] + "_Extra");
                }
        
                getAttrs(attrs, function (extras) {
                    for (var i = 0; i < idArray.length; i++) {
                        importExtra(extras["repeating_Extras_" + idArray[i] + "_Extra"]);
                        removeRepeatingRow("repeating_Extras_" + idArray[i]);
                    }
        
                    setAttrs(newRowAttrs);
                });
            });
        });
    };
    
    const importExtra = (extra) => {
        if (isNullOrWhitespace(extra))
            return;
    
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_extras_" + newRowId + "_description"] = extra;
        setAttrs(newRowAttrs);
    };
    
    function ImportStresses (runFirstTimeSetup, default_stressSkills) {
        var attr = [];
        attr.push("PhyGoverningSkill");
        attr.push("MenGoverningSkill");
        for (var i = 1; i < 5; i++) {
            attr.push("Phy" + i);
            attr.push("Phy" + i + "Active");
            attr.push("Men" + i);
            attr.push("Men" + i + "Active");
        }
        
        getAttrs(attr, function (basicValues) {
            var phyGoverningSkill = basicValues["PhyGoverningSkill"];
            if (isNullOrWhitespace(phyGoverningSkill))
                phyGoverningSkill = "Physique";
            
            var menGoverningSkill = basicValues["MenGoverningSkill"];
            if (isNullOrWhitespace(menGoverningSkill))
                menGoverningSkill = "Will";
            
            getSectionIDs("repeating_Stress", function (idArray) {
                if (idArray.length == 0) {
                    importStress("Physical", phyGoverningSkill, "Phy", basicValues);
                    importStress("Mental", menGoverningSkill, "Men", basicValues);
                        
                    if (!isNullOrWhitespace(runFirstTimeSetup))
                        SetDefaultStress(default_stressSkills);
    
                    return;
                }
            
                var attrs = [];
                idArray.forEach(id =>  {
                    attrs.push("repeating_Stress_" + id + "_Name");
                    attrs.push("repeating_Stress_" + id + "_Mirrored");
                    for (var x = 1; x < 5; x++) {
                        attr.push("repeating_Stress_" + id + "_Stress" + x);
                        attr.push("repeating_Stress_" + id + "_Stress" + x + "Active");
                    }
                });
    
                getAttrs(attrs, function (repValues) {
                    var mirrors = [];
                    for (var i = 0; i < idArray.length; i++) {
                        mirrors.push("repeating_StressOptions_" + repValues["repeating_Stress_" + idArray[i] + "_Mirrored"] + "_GoverningSkill");
                    }
        
                    getAttrs(mirrors, function (mirroredValues) {
                        importStress("Physical", phyGoverningSkill, "Phy", basicValues);
                        importStress("Mental", menGoverningSkill, "Men", basicValues);
    
                        idArray.forEach(id => {
                            importStress(repValues["repeating_Stress_" + id + "_Name"],
                                mirroredValues["repeating_StressOptions_" + repValues["repeating_Stress_" + id + "_Mirrored"] + "_GoverningSkill"],
                                "repeating_Stress_" + id + "_Stress", repValues);
                            
                            removeRepeatingRow("repeating_StressOptions_" + repValues["repeating_Stress_" + id + "_Mirrored"]);
                            removeRepeatingRow("repeating_Stress_" + id);
                        });
                        
                        if (!isNullOrWhitespace(runFirstTimeSetup))
                            SetDefaultStress(default_stressSkills);
                    });
                });
            });    
        });
    };
    
    const importStress = (stress, skill, prefix, attrs) => {
        var newRowAttrs = {};
        var stressMax = 0;
    
        var newRowId = generateRowID();
        newRowAttrs["repeating_stress_" + newRowId + "_name"] = stress.trim();
    
        for (var i = 1; i < 5; i++) {
            if(!isNullOrWhitespace(attrs[prefix + i + "Active"])) {
                stressMax++;
                if(!isNullOrWhitespace(attrs[prefix + i]))
                    newRowAttrs["repeating_stress_" + newRowId + "_isUsed" + i] = i;
            }
            else
                return;
        }
    
        if (stressMax == 0)
            return;
    
        newRowAttrs["repeating_stress_" + newRowId + "_usable"] = stressMax;
    
        if (!isNullOrWhitespace(skill)) {
            newRowAttrs["repeating_stress_" + newRowId + "_skill"] = skill.trim();
            newRowAttrs["repeating_stress_" + newRowId + "_bound"] = 1;
        }
    
        setAttrs(newRowAttrs);
    };
    
    function SetDefaultStress (default_stressSkills) {
        if (!isNullOrWhitespace(default_stressSkills)) {
            getSectionIDs("repeating_stress", function (idArray) {
                if (idArray.length == 0) {
                    var stressSkills = default_stressSkills.split(",");
                    var newRowAttrs = {};
                    stressSkills.forEach(element => {
                        var keyValuePair = element.split(":");
                        var newRowId = generateRowID();
                        newRowAttrs["repeating_stress_" + newRowId + "_name"] = keyValuePair[0].trim();
                        if (keyValuePair.length > 1) {
                            var skill = keyValuePair[1].trim();
                            var usable = Number(skill);
                            if (isNaN(usable)) {
                                newRowAttrs["repeating_stress_" + newRowId + "_skill"] = skill;
                                newRowAttrs["repeating_stress_" + newRowId + "_usable"] = 2;
                                newRowAttrs["repeating_stress_" + newRowId + "_bound"] = 1;
                            }
                            else {
                                newRowAttrs["repeating_stress_" + newRowId + "_usable"] = usable;
                                newRowAttrs["repeating_stress_" + newRowId + "_bound"] = 0;
                            }
                            newRowAttrs["repeating_stress_" + newRowId + "_options_flag"] = 0;
                        }
                        else {
                            newRowAttrs["repeating_stress_" + newRowId + "_options_flag"] = "on";
                        }
                    });
                    setAttrs(newRowAttrs);
                }
            });
        }
    };
    
    function ImportConsequences (runFirstTimeSetup, default_consequences, show_conditions_flag) {
        var attr = [];
        attr.push("MildConsequence");
        attr.push("MildInvoke");
        attr.push("ModerateConsequence");
        attr.push("ModerateInvoke");
        attr.push("SevereConsequence");
        attr.push("SevereInvoke");
        
        getAttrs(attr, function (basicValues) {
            getSectionIDs("repeating_Cons", function (idArray) {
                if (idArray.length == 0) {
                    if (isNullOrWhitespace(basicValues["MildConsequence"])
                        && isNullOrWhitespace(basicValues["MildInvoke"])
                        && isNullOrWhitespace(basicValues["ModerateConsequence"])
                        && isNullOrWhitespace(basicValues["ModerateInvoke"])
                        && isNullOrWhitespace(basicValues["SevereConsequence"])
                        && isNullOrWhitespace(basicValues["SevereInvoke"])) {
                            if (!isNullOrWhitespace(runFirstTimeSetup))
                                SetDefaultConsequences(default_consequences, show_conditions_flag);
                            return;
                        }
                    
                    importConsequence(2, basicValues["MildConsequence"], !isNullOrWhitespace(basicValues["MildInvoke"]));
                    importConsequence(4, basicValues["ModerateConsequence"], !isNullOrWhitespace(basicValues["ModerateInvoke"]));
                    importConsequence(6, basicValues["SevereConsequence"], !isNullOrWhitespace(basicValues["SevereInvoke"]));
                    return;
                }
            
                var attrs = [];
                for (var i = 0; i < idArray.length; i++) {
                    attrs.push("repeating_Cons_" + idArray[i] + "_conType");
                    attrs.push("repeating_Cons_" + idArray[i] + "_Consequence");
                    attrs.push("repeating_Cons_" + idArray[i] + "_Invoke");
                }
    
                getAttrs(attrs, function (repValues) {
                    importConsequence(2, basicValues["MildConsequence"], !isNullOrWhitespace(basicValues["MildInvoke"]));
                    importConsequence(4, basicValues["ModerateConsequence"], !isNullOrWhitespace(basicValues["ModerateInvoke"]));
                    importConsequence(6, basicValues["SevereConsequence"], !isNullOrWhitespace(basicValues["SevereInvoke"]));
    
                    for (var i = 0; i < idArray.length; i++) {
                        var worth = 0;
                        switch (repValues["repeating_Cons_" + idArray[i] + "_conType"]) {
                            case "Mild":
                                worth = 2;
                                break;
                            case "Moderate":
                                worth = 4;
                                break;
                            case "Severe":
                                worth = 6;
                                break;
                        }
                    
                        importConsequence(worth,
                            repValues["repeating_Cons_" + idArray[i] + "_Consequence"],
                            !isNullOrWhitespace(repValues["repeating_Cons_" + idArray[i] + "_Invoke"]));
                        
                        removeRepeatingRow("repeating_Cons_" + idArray[i]);
                    }
                });
            });    
        });
    };
    
    const importConsequence = (worth, aspect, addBonus) => {
        if (!isNaN(worth) && worth > 0) {
            var newRowAttrs = {};
            var newRowId = generateRowID();
            newRowAttrs["repeating_consequences_" + newRowId + "_worth"] = worth;
            newRowAttrs["repeating_consequences_" + newRowId + "_aspect"] = aspect;
            newRowAttrs["repeating_consequences_" + newRowId + "_worth_text"] = getConsequenceText(worth);
    
            setAttrs(newRowAttrs);
    
            if (addBonus)
                importSitAspect(aspect, 1);
        }
    };
    
    function SetDefaultConsequences (default_consequences, show_conditions_flag) {
        if (!isNullOrWhitespace(default_consequences)) {
            getSectionIDs("repeating_consequences", function (idArray) {
                if (idArray.length == 0) {
                    var consequences = default_consequences.split(",")
                    var newRowAttrs = {};
                    consequences.forEach(consequence => {
                        var elements = consequence.split("|");
                        var worth = Number(elements[0].trim());
                        if (!isNaN(worth) && worth > 0) {
                            var newRowId = generateRowID();
                            newRowAttrs["repeating_consequences_" + newRowId + "_worth"] = worth;
    
                            if (elements.length > 1)
                                newRowAttrs["repeating_consequences_" + newRowId + "_aspect"] = elements[1];
                            if (show_conditions_flag == "1")
                                newRowAttrs["repeating_consequences_" + newRowId + "_worth_text"] = getConditionsText(worth);
                            else
                                newRowAttrs["repeating_consequences_" + newRowId + "_worth_text"] = getConsequenceText(worth);
                        }
                    });
                    setAttrs(newRowAttrs);
                }
            });
        }
    };
    
    function ImportNotes () {
        getAttrs(["Notes"], function (values) {
            if(isNullOrWhitespace(values["Notes"]))
                return;
    
            var newRowAttrs = {};
            var newRowId = generateRowID();
            newRowAttrs["repeating_notes_" + newRowId + "_body"] = values["Notes"];
    
            setAttrs(newRowAttrs);
        });
    };
    
    on("change:repeating_consequences:worth", function (eventInfo) {
        getAttrs(["show_conditions_flag"], function (values) {
            if (!isNullOrWhitespace(values["show_conditions_flag"]))
                setAttrs({ repeating_consequences_worth_text: getConditionsText(Number(eventInfo.newValue)) });
            else
                setAttrs({ repeating_consequences_worth_text: getConsequenceText(Number(eventInfo.newValue)) });
        });
    });
    
    on("change:show_conditions_flag", function (eventInfo) {
        getSectionIDs("repeating_consequences", function (idArray) {
            if (idArray.length == 0)
                return;
    
            var attrs = [];
            for (var i = 0; i < idArray.length; i++) {
                attrs.push("repeating_consequences_" + idArray[i] + "_worth");
            }
    
            getAttrs(attrs, function (values) {
                var newRowAttrs = {};
                for (var i = 0; i < idArray.length; i++) {
                    var worth = Number(values["repeating_consequences_" + idArray[i] + "_worth"]);
                    if (!isNullOrWhitespace(eventInfo.newValue))
                        newRowAttrs["repeating_consequences_" + idArray[i] + "_worth_text"] = getConditionsText(worth);
                    else
                        newRowAttrs["repeating_consequences_" + idArray[i] + "_worth_text"] = getConsequenceText(worth);
                }
    
                setAttrs(newRowAttrs);
            });
        });
    });
    
    on("change:repeating_skills:skill", function (eventInfo) {
        skillChanged(eventInfo.previousValue, 0);
        getAttrs(["repeating_skills_shiftLevel"], function (values) {
            skillChanged(eventInfo.newValue, Number(values["repeating_skills_shiftLevel"]));
        });
    });
    
    on("change:repeating_skills:shiftLevel", function (eventInfo) {
        var skillLevel = Number(eventInfo.newValue);
        setAttrs({ repeating_skills_shiftLevelText: getShiftText(skillLevel) });
        getAttrs(["repeating_skills_skill"], function (values) {
            skillChanged(values["repeating_skills_skill"], skillLevel);
        });
    });
    
    on("clicked:addSkill8", function () {
        createSkill(8);
    });
    
    on("clicked:removeSkill8", function () {
        removeSkill(8);
    });
    
    on("clicked:addSkill7", function () {
        createSkill(7);
    });
    
    on("clicked:removeSkill7", function () {
        removeSkill(7);
    });
    
    on("clicked:addSkill6", function () {
        createSkill(6);
    });
    
    on("clicked:removeSkill6", function () {
        removeSkill(6);
    });
    
    on("clicked:addSkill5", function () {
        createSkill(5);
    });
    
    on("clicked:removeSkill5", function () {
        removeSkill(5);
    });
    
    on("clicked:addSkill4", function () {
        createSkill(4);
    });
    
    on("clicked:removeSkill4", function () {
        removeSkill(4);
    });
    
    on("clicked:addSkill3", function () {
        createSkill(3);
    });
    
    on("clicked:removeSkill3", function () {
        removeSkill(3);
    });
    
    on("clicked:addSkill2", function () {
        createSkill(2);
    });
    
    on("clicked:removeSkill2", function () {
        removeSkill(2);
    });
    
    on("clicked:addSkill1", function () {
        createSkill(1);
    });
    
    on("clicked:removeSkill1", function () {
        removeSkill(1);
    });
    
    on("clicked:addSkill0", function () {
        createSkill(0);
    });
    
    on("clicked:removeSkill0", function () {
        removeSkill(0);
    });
    
    on("clicked:addSkillN1", function () {
        createSkill(-1);
    });
    
    on("clicked:removeSkillN1", function () {
        removeSkill(-1);
    });
    
    on("clicked:addSkillN2", function () {
        createSkill(-2);
    });
    
    on("clicked:removeSkillN2", function () {
        removeSkill(-2);
    });
    
    on("change:repeating_stunts:skill", function (eventInfo) {
        getSectionIDs("repeating_skills", function (idArray) {
            if (idArray.length == 0)
                return;
    
            var attrs = [];
            for (var i = 0; i < idArray.length; i++) {
                attrs.push("repeating_skills_" + idArray[i] + "_skill");
                attrs.push("repeating_skills_" + idArray[i] + "_shiftLevel");
                attrs.push("repeating_skills_" + idArray[i] + "_shiftLevelText");
            }
    
            getAttrs(attrs, function (values) {
                var skillShiftLevel = 0;
                var skillShiftLevelText = getShiftText(0);
    
                for (var i = 0; i < idArray.length; i++) {
                    if (values["repeating_skills_" + idArray[i] + "_skill"] == eventInfo.newValue) {
                        skillShiftLevel = values["repeating_skills_" + idArray[i] + "_shiftLevel"];
                        skillShiftLevelText = values["repeating_skills_" + idArray[i] + "_shiftLevelText"];
                        break;
                    }
                }
    
                setAttrs({
                    repeating_stunts_skillShiftLevel: skillShiftLevel,
                    repeating_stunts_skillShiftLevelText: skillShiftLevelText
                });
            });
        });
    });
    
    on("change:repeating_stunts:bonusShifts", function (eventInfo) {
        var description = getShiftText(Number(eventInfo.newValue));
        setAttrs({ repeating_stunts_bonusShiftsText: description });
    });
    
    on("change:repeating_stunts:type", function (eventInfo) {
        var description;
        switch (Number(eventInfo.newValue)) {
            case 1:
                description = "New Action to Skill";
                break;
            case 2:
                description = "Bonus to Action";
                break;
            default:
                description = "Rules Exception";
                break;
        }
        setAttrs({ repeating_stunts_typeText: description });
    
        if (Number(eventInfo.newValue) == 2) {
            getAttrs(["repeating_stunts_bonusShifts"], function (values) {
                if (isNullOrWhitespace(values["repeating_stunts_bonusShifts"])) {
                    var description = getShiftText(2);
                    setAttrs({ repeating_stunts_bonusShiftsText: description, repeating_stunts_bonusShifts: 2 });
                }
                else {
                    var description = getShiftText(Number(values["repeating_stunts_bonusShifts"]));
                    setAttrs({ repeating_stunts_bonusShiftsText: description });
                }
            });
        }
    });
    
    on("change:repeating_stress:skill", function (eventInfo) {
        getSectionIDs("repeating_skills", function (idArray) {
            if (idArray.length == 0)
                return;
    
            var attrs = [];
            for (var i = 0; i < idArray.length; i++) {
                attrs.push("repeating_skills_" + idArray[i] + "_skill");
                attrs.push("repeating_skills_" + idArray[i] + "_shiftLevel");
            }
    
            getAttrs(attrs, function (values) {
                var stressMax;
    
                for (var i = 0; i < idArray.length; i++) {
                    if (values["repeating_skills_" + idArray[i] + "_skill"] == eventInfo.newValue) {
                        var skillShiftLevel = Number(values["repeating_skills_" + idArray[i] + "_shiftLevel"]);
                        stressMax = getStressMax(skillShiftLevel);
                    }
                }
    
                if (stressMax != null) {
                    setAttrs({ repeating_stress_usable: stressMax, repeating_stress_bound: 1 });
                }
            });
        });
    });
    
    on("change:repeating_stress:usable", function (eventInfo) {
        if (eventInfo.sourceType != "sheetworker")
            setAttrs({ repeating_stress_bound: 0 });
    });
    
    on("clicked:clearStress", function () {
        getSectionIDs("repeating_stress", function (idArray) {
            if (idArray.length == 0)
                return;
    
            var editAttrs = {};
            for (var i = 0; i < idArray.length; i++) {
                for (var x = 1; x < 9; x++) {
                    editAttrs["repeating_stress_" + idArray[i] + "_isUsed" + x] = "";
                }
            }
    
            setAttrs(editAttrs);
        });
    });
    
    function getShiftText(shiftLevel) {
        switch (shiftLevel) {
            case 8:
                return "Legendary";
            case 7:
                return "Epic";
            case 6:
                return "Fantastic";
            case 5:
                return "Superb";
            case 4:
                return "Great";
            case 3:
                return "Good";
            case 2:
                return "Fair";
            case 1:
                return "Average";
            case 0:
                return "Mediocre";
            case -1:
                return "Poor";
            case -2:
                return "Terrible";
        }
    
        if (shiftLevel > 8) {
            return "Legendary+" + (shiftLevel - 8);
        }
        if (shiftLevel < -2) {
            return "Terrible" + (shiftLevel + 2);
        }
    
        return "";
    };
    
    function getConsequenceText(worth) {
        switch (Number(worth)) {
            case 2:
                return "Mild";
            case 4:
                return "Moderate";
            case 6:
                return "Severe";
            case 8:
                return "Extreme";
            default:
                return "Custom";
        }
    };
    
    function getConditionsText(worth) {
        switch (Number(worth)) {
            case 1:
                return "Fleeting";
            case 2:
                return "Sticky";
            case 4:
                return "Lasting";
            default:
                return "Custom";
        }
    };
    
    function getStressMax(skillShiftLevel) {
        if (skillShiftLevel < 1) {
            return 2;
        }
    
        if (skillShiftLevel < 3) {
            return 3;
        }
    
        return 4;
    };
    
    const createSkill = (skillLevel) => {
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_skills_" + newRowId + "_shiftLevel"] = skillLevel;
        newRowAttrs["repeating_skills_" + newRowId + "_shiftLevelText"] = getShiftText(skillLevel);
        setAttrs(newRowAttrs);
    };
    
    const removeSkill = (skillLevel) => {
        getSectionIDs("repeating_skills", function (idArray) {
            if (idArray.length == 0)
                return;
    
            var attrs = [];
            for (var i = 0; i < idArray.length; i++) {
                attrs.push("repeating_skills_" + idArray[i] + "_skill");
                attrs.push("repeating_skills_" + idArray[i] + "_shiftLevel");
            }
    
            getAttrs(attrs, function (values) {
                var lastRowId;
                var lastSkill;
    
                for (var i = 0; i < idArray.length; i++) {
                    if (Number(values["repeating_skills_" + idArray[i] + "_shiftLevel"]) == skillLevel) {
                        lastRowId = idArray[i];
                        lastSkill = values["repeating_skills_" + idArray[i] + "_skill"]
                    }
                }
    
                if (lastRowId != null) {
                    removeRepeatingRow("repeating_skills_" + lastRowId);
                    skillChanged(lastSkill, 0);
                }
            });
        });
    };
    
    const skillChanged = (skill, skillLevel) => {
        if (isNullOrWhitespace(skill))
            return;
    
        if (skillLevel == null || isNaN(skillLevel))
            skillLevel = 0;
    
        var skillLevelDesc = getShiftText(skillLevel);
    
        //adjust Stunts
        getSectionIDs("repeating_stunts", function (idArray) {
            if (idArray.length == 0)
                return;
    
            var attrs = [];
            for (var i = 0; i < idArray.length; i++) {
                attrs.push("repeating_stress_" + idArray[i] + "_skill");
            }
    
            getAttrs(attrs, function (values) {
                var editAttrs = {};
                for (var i = 0; i < idArray.length; i++) {
                    if (!isNullOrWhitespace(values["repeating_stress_" + idArray[i] + "_bound"])
                            && values["repeating_stress_" + idArray[i] + "_skill"] == skill) {
                        editAttrs["repeating_stress_" + idArray[i] + "_shiftLevel"] = skillLevel;
                        editAttrs["repeating_stress_" + idArray[i] + "_shiftLevelText"] = skillLevelDesc;
                    }
                }
    
                setAttrs(editAttrs);
            });
        });
    
        //adjust Stress
        getSectionIDs("repeating_stress", function (idArray) {
            if (idArray.length == 0)
                return;
    
            var attrs = [];
            for (var i = 0; i < idArray.length; i++) {
                attrs.push("repeating_stress_" + idArray[i] + "_skill");
                attrs.push("repeating_stress_" + idArray[i] + "_bound");
            }
    
            getAttrs(attrs, function (values) {
                var editAttrs = {};
                for (var i = 0; i < idArray.length; i++) {
                    if (!isNullOrWhitespace(values["repeating_stress_" + idArray[i] + "_bound"])
                            && values["repeating_stress_" + idArray[i] + "_skill"] == skill) {
                        editAttrs["repeating_stress_" + idArray[i] + "_usable"] = getStressMax(skillLevel);
                    }
                }
    
                setAttrs(editAttrs);
            });
        });
    }
    
    const isNullOrWhitespace = (attr) => !(attr && (attr.trim ? attr.trim() && attr.trim() != "0" : attr > 0));
</script>



