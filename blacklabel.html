<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="blacklabel.css">
</head>

<div class="sheet-container">
    <!--MECHANICS SECTION: 
        1. Find a way to connect the stats to the token
    -->

        <div class="sheet-section-mechanics sheet-section sheet-quarter">

            <div class="sheet-row" style="padding-left: 5px;">

                <div class="mechanics-container">

                    <img src="https://raw.github.com/milostuff/black-label-sheet/main/hp.png" alt="hp" style="width:150px; height: 150px;">

                    <input type="number" name="attr_hp" value="0"/>

                    <div class="circle">
                        <input type="number" name="attr_hp" value="10"/>
                    </div>

                <div class="mechanics-container">

                    <img src="https://raw.github.com/milostuff/black-label-sheet/main/shield.png" alt="shield" style="width:150px; height: 150px">

                    <input type="number" name="attr_shield" value="0" style="left: 59px"/>

                    <div class="circle">
                        <input type="number" name="attr_shield" value="0"/>
                    </div>

                </div>

                <div class="mechanics-container" >

                    <img src="https://raw.github.com/milostuff/black-label-sheet/main/bp.png" alt="bp" style="width:150px; height: 150px;">

                    <input type="number" name="attr_bp" value="0"/>

                    <div class="circle">
                        <input type="number" name="attr_bp" value="5"/>
                    </div>
                </div>
            
            </div>

        </div>

    </div>

    <!--ID SECTION: DONE -->
        <div class="sheet-section-id sheet-section sheet-threequarters">
            
            <div class="sheet-header">
                <span>ID</span>
            </div>

            <input class="sheet-level-flag sheet-hidden" type="checkbox" name="attr_show_level_flag" value="1" checked />
            <div class="sheet-section sheet-section-id-info">
                <div class="sheet-repitem">
                    <input type="text" name="attr_id_name" placeholder="Name" />
                </div>

                <div class="sheet-row">
                    <input type="text" name="attr_id_past" placeholder="Past" style="width:45%"/>
                    <input type="text" name="attr_id_discipline" placeholder="Discipline" style="width:50%"/>
                </div>
                
                <div class="sheet-repitem">
                    <textarea name="attr_id_description" placeholder="Description"></textarea>
                </div>
            </div>

            <div class="sheet-section sheet-section-id-level">
                <div class="sheet-repitem">
                    <label style="font-size: smaller;">Level</label>
                    <input type="number" name="attr_id_level" placeholder="0" />
                </div>
            </div>
        </div>

     <!--SKILLS SECTION: 
        1. Add role dice for each skill (same dice, different modifiers)
        2. Add advantage/disadvantage
    -->
        
        <div class="sheet-section-skills sheet-section sheet-half">
            <div class="sheet-header">
                <span>Stats and Skills</span>
            </div>

            <div class="sheet-row" style="padding-top:10px; padding-left: 7px;">

                <div class="sheet-col">
                        
                    <div class="stat-header" style="padding-left: 45px">
                        <label>Body (<input type="number" name="attr_stat_body" value="0"/>)</label>
                    </div>

                    <div class="container-skill">
                            
                        <button type="roll" class="sheet-action-button" name="roll_strength" value="&{template:skill} {{name= Strength}} {{boon= [[1d12+@{skill_str}[skill_str]]]}} {{dread= [[1d12+@{skill_str}[skill_str]]]}}">
                            <span>Strength</span>
                        </button>
                        <input type="number" name="attr_skill_str" value="0" />
                        <label>Will</label>
                        <input type="number" name="attr_skill_wil" value="0" />
                        <label>Vigor</label>
                        <input type="number" name="attr_skill_vig" value="0" />

                    </div>

                </div>

                <div class="sheet-col">

                    <div class="stat-header" style="padding-left: 25px">
                        <label>Technique (<input type="number" name="attr_stat_tech" value="0"/>)</label>
                    </div>

                    <div class="container-skill">
                        <label>Acrobratics</label>
                        <input type="number" name="attr_skill_acr" value="0" />
                        <label>Finesse</label>
                        <input type="number" name="attr_skill_fin" value="0" />
                        <label>Control</label>
                        <input type="number" name="attr_skill_cont" value="0" />
                    </div>

                </div>

                <div class="sheet-col">

                    <div class="stat-header" style="padding-left: 30px">
                        <label>Presence (<input type="number" name="attr_stat_pres" value="0" />)</label>
                    </div>

                    <div class="container-skill">
                        
                        <label>Rapport</label>
                        <input type="number" name="attr_skill_rap" value="0" />
                        <label>Menace</label>
                        <input type="number" name="attr_skill_men" value="0" />
                        <label>Convince</label>
                        <input type="number" name="attr_skill_con" value="0" />
                    </div>
                </div>

                <div class="sheet-col col-wrap">

                    <div class="stat-header" style="padding-left: 45px">
                        <label>Mind (<input type="number" name="attr_stat_mind" value="0"/>)</label>
                    </div>
                    
                    <div class="container-skill">

                        <label>Empathy</label>
                        <input type="number" name="attr_skill_emp" value="0" />
                        <label>Lore</label>
                        <input type="number" name="attr_skill_lore" value="0" />
                        <label>Insight</label>
                        <input type="number" name="attr_skill_ins" value="0" />
                    </div>
                </div>

            </div>
    
        </div>

    <!--MECHANICS 2 SECTION: 
        1. Speed, proficiency, what else? currency?
    -->

        <div class="sheet-section-mechanics2 sheet-section sheet-quarter">
            <div class="sheet-header">
                Mechanics
            </div>
        </div>

        <div class="sheet-break"></div>

        

    <!--BONUSES SECTION: DONE-->
        <div class="sheet-section-bonuses sheet-section sheet-half">
            <div class="sheet-header">
                <span>Bonuses and Stunts</span>
            </div>
            <fieldset class="repeating_bonuses">
                <div class="sheet-item-options">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                    <div class="sheet-display">
                        <input class="sheet-item-options-flag2" type="checkbox" name="attr_more_flag" checked="checked" />
                        <span>E</span>
                    </div>
                    <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <input type="text" name="attr_bonus_name" placeholder="Name" />
                    <textarea name="attr_bonus_desc" placeholder="Description"></textarea>
                </div>
                <div class="sheet-display">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_more_flag" checked="checked" />
                    <div class="sheet-display">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button" name="roll_bonuses" value="&{template:bonuses} {{bonuses=@{bonus_name}}} {{description=@{bonus_desc}}}">
                                <span name="attr_bonus_name"></span>
                            </button>
                        </h3>
                        
                        <span name="attr_bonus_desc" class="sheet-keep-whitespace"> </span>
                    </div>
                    <div class="sheet-options">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button sheet-tooltip" name="roll_bonuses" value="&{template:bonuses} {{bonuses=@{bonus_name}}} {{description=@{bonus_desc}}}">
                                <span name="attr_bonus_name"></span>
                                <span name="attr_bonus_desc" class="sheet-tooltipText sheet-keep-whitespace"></span>
                            </button>
                        </h3>
                    </div>
                </div>
            </fieldset>
        </div>

    <!--KEYWORDS SECTION: DONE-->
        <div class="sheet-section-keywords sheet-section sheet-half">
            <div class="sheet-header">
                <span>Keywords</span>
            </div>
            <fieldset class="repeating_keywords">
                <div class="sheet-item-options">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                    <div class="sheet-display">
                        <input class="sheet-item-options-flag2" type="checkbox" name="attr_more_flag" checked="checked" />
                        <span>E</span>
                    </div>
                    <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <input type="text" name="attr_key_name" placeholder="Name" />
                    <input type="text" name="attr_key_source" placeholder="Source" />
                    <textarea name="attr_key_desc" placeholder="Description"></textarea>
                </div>
                <div class="sheet-display">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_more_flag" checked="checked" />
                    <div class="sheet-display">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button" name="roll_keywords" value="&{template:keywords} {{keyword=@{key_name}}} {{source=@{key_source}}} {{description=@{key_desc}}}">
                                <span name="attr_key_name"></span>
                            </button>
                        </h3>

                        <div class="row">
                            <span class="sheet-inlineLabel">Source</span>
                            <span class="sheet-inlineLabel">: </span>
                            <span name="attr_key_source"></span>
                        </div>   
                        
                        <span name="attr_key_desc" class="sheet-keep-whitespace"> </span>
                    </div>
                    <div class="sheet-options">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button sheet-tooltip" name="roll_keywords" value="&{template:keywords} {{keyword=@{key_name}}} {{source=@{key_source}}} {{description=@{key_desc}}}">
                                <span name="attr_key_name"></span>
                                <span name="attr_key_source"></span>
                                <span name="attr_key_desc" class="sheet-tooltipText sheet-keep-whitespace"></span>
                            </button>
                        </h3>
                    </div>
                </div>
            </fieldset>
        </div>

        <div class="sheet-break"></div>

    <!--STRESS SECTION: 
        1. Make it so that stress and sanity are default to 4 and does not show up as the edit view in default 
    -->
        <input class="sheet-stress-flag sheet-hidden" type="checkbox" name="attr_show_stress_flag" value="1" />

        <div class="sheet-section-stress sheet-section sheet-half">
            <div class="sheet-header">
                <span>Status</span>
                <div class="sheet-section-options">
                    <button type="action" name="act_clearStress" >
                        <span>#</span>
                    </button>
                </div>
            </div>
            <fieldset class="repeating_stress">
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <input type="text" name="attr_stress_name" placeholder="Name" />
                    <select name="attr_usable">
                        <option value=1>1</option>
                        <option value=2>2</option>
                        <option value=3>3</option>
                        <option value=4 selected>4</option>
                        <option value=5>5</option>
                        <option value=6>6</option>
                        <option value=7>7</option>
                        <option value=8>8</option>
                    </select>
                    <input type="hidden" name="attr_bound" />
                    <div class="sheet-item-options sheet-stress-edit">
                        <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                        <span>3</span>
                    </div>
                </div>
                <div class="sheet-display">
                    <div class="sheet-stress-header">
                        <span class="sheet-stress-header-name" name="attr_name"></span>
                        <span class="sheet-stress-header-skill" name="attr_skill"></span>
                    </div>
                    <div class="sheet-stress-row">
                        <input type="hidden" name="attr_usable" />
                        <input type="checkbox" name="attr_isUsed1" title="1" value=1 />
                        <input type="checkbox" name="attr_isUsed2" title="2" value=2 />
                        <input type="checkbox" name="attr_isUsed3" title="3" value=3 />
                        <input type="checkbox" name="attr_isUsed4" title="4" value=4 />
                        <input type="checkbox" name="attr_isUsed5" title="5" value=5 />
                        <input type="checkbox" name="attr_isUsed6" title="6" value=6 />
                        <input type="checkbox" name="attr_isUsed7" title="7" value=7 />
                        <input type="checkbox" name="attr_isUsed8" title="8" value=8 />
                    </div>
                </div>
            </fieldset>
        </div>

    <!--CONDITIONS SECTION: 
        1. Don't change the naming convention you dont want to deal with the edits
    -->
        <input class="sheet-conditions-flag sheet-hidden" type="checkbox" name="attr_show_conditions_flag" value="1" />

        <div class="sheet-section-consequences sheet-section sheet-half">
            <div class="sheet-header">
                <span>Conditions</span>
            </div>
            <div class="sheet-repitem sheet-consequence-row">
                <span class="sheet-consequence-worth"></span>
            </div>
            <fieldset class="repeating_consequences">
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">
                    <select name="attr_worth">
                        <option value=2 selected><span>Mild</span> (2)</option>
                        <option value=4><span>Moderate</span> (4)</option>
                        <option value=6><span>Severe</span> (6)</option>
                        <option value=8><span>Extreme</span> (8)</option>
                    </select>
                    <input type="hidden" name="attr_worth_text" value="Mild"/>
                    <input type="checkbox" name="attr_isUsed" class="sheet-hidden" value="1" />
                    <div class="sheet-item-options sheet-consequence-edit">
                        <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                        <span>3</span>
                    </div>
                </div>
                <div class="sheet-display sheet-consequence-row">
                    <div class="sheet-consequence-worth">
                            <span class="sheet-worth-value" name="attr_worth"></span>
                            <span class="sheet-worth-text" name="attr_worth_text"></span>
                    </div>
                    <input type="text" name="attr_aspect" class="sheet-consequence-aspect" />
                </div>
            </fieldset>
        </div>
        
        <div class="sheet-break"></div>
    
    <!--INVENTORY SECTION:-->

        <div class="sheet-section-inventory sheet-section sheet-quarter">
            <div class="sheet-header">
                <span>Inventory and Equipment</span>
            </div>
            <fieldset class="repeating_inventory">
                <input type="number" name="attr_invent_qty" placeholder="Qty" style="width:25%"/>
                <input type="text" name="attr_invent_name" placeholder="Name" style="width:55%" />
            </fieldset>
        </div>
    
    <!--WEAPONS SECTION:
        1. Primary and Secondary weapons (name, trait/range, type, feature, damage dice)
        2. Add rolls to hit and to damage 

        1. Show weapon roll and damage when pressed
        2. Damage and Bonus does not show up auhhuhuh
        3. Have an option to set weapon to active/inactive and primary/secondary
    
    -->

        <input class="sheet-weapons-flag sheet-hidden" type="checkbox" name="attr_show_weapons_flag" value="1" />
        
        <div class="sheet-section-weapons sheet-section sheet-threequarters">
            <div class="sheet-header">
                <span>Weapons</span>
            </div>
            <fieldset class="repeating_weapons">
                <div class="sheet-item-options">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                    <div class="sheet-display">
                        <input class="sheet-item-options-flag2" type="checkbox" name="attr_more_flag" checked="checked" />
                        <span>E</span>
                    </div>
                    <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-options">

                    <div class="row">
                        <input type="text" name="attr_weapons_name" placeholder="Name" />
                        <input type="text" name="attr_weapons_trait" placeholder="Trait" />
                    </div>

                    <input type="text" name="attr_weapons_range" placeholder="Range" />
                    <input type="text" name="attr_weapons_type" placeholder="Type" />

                    <select name="attr_weapon_damage_die">
                        <option value="" disabled selected hidden>Damage</option>
                        <option value="1d4">1d4</option>
                        <option value="1d6">1d6</option>
                        <option value="1d8">1d8</option>
                        <option value="1d10">1d10</option>
                        <option value="1d12">1d12</option>
                        <option value="1d20">1d20</option>
                    </select>


                    <span class="sheet-plus-sign">+</span>
                    
                    <select name="attr_weapon_damage_bonus">
                        <option value="" disabled selected hidden>Bonus</option>
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>


                    <textarea name="attr_weapons_feature" placeholder="Feature"></textarea>
                </div>
                <div class="sheet-display">
                    <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_more_flag" checked="checked" />
                    <div class="sheet-display">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button" name="roll_weapons" value="&{template:weapons} {{name=@{weapons_name}}} {{trait=@{weapons_trait}}} {{range=@{weapons_range}}} {{damage=@{weapons_damage_die_text}}} {{bonus=@{weapons_damage_bonus_text}}} {{feature=@{weapons_feature}}}">
                                <span name="attr_weapons_name"></span>
                            </button>
                        </h3>

                        <div class="row">
                            <span name="attr_weapons_trait"></span>
                            <span name="attr_weapons_range"></span>
                            <span name="attr_weapons_type"></span>
                        </div>   

                        <span name="attr_weapons_damage_die_text"></span>
                        <span name="attr_weapons_damage_bonus_text"></span>
                        
                        <span name="attr_weapons_feature" class="sheet-keep-whitespace"> </span>
                    </div>
                    <div class="sheet-options">
                        <h3 class="sheet-right-buttons">
                            <button type="roll" class="sheet-action-button sheet-tooltip" name="roll_weapons" value="&{template:weapons} {{name=@{weapons_name}}} {{trait=@{weapons_trait}}} {{range=@{weapons_range}}} {{damage=@{weapons_damage_die_text}}} {{bonus=@{weapons_damage_bonus_text}}} {{feature=@{weapons_feature}}}">
                                <span name="attr_weapons_name"></span>
                                <span name="attr_weapons_trait"></span>
                                <span name="attr_weapons_range"></span>
                                <span name="attr_weapons_type"></span>
                                <span name="attr_weapons_damage_die_text"></span>
                                <span name="attr_weapons_damage_bonus_text"></span>
                                <span name="attr_weapons_feature" class="sheet-tooltipText sheet-keep-whitespace"></span>
                            </button>
                        </h3>
                    </div>
                </div>
            </fieldset>

        </div>

        <div class="sheet-break"></div>

    <!--NOTES SECTION:
        1. Make a part of the sheet instead of an individual tab
    -->

        <input class="sheet-weapons-flag sheet-hidden" type="checkbox" name="attr_show_weapons_flag" value="1" />

        <div class="sheet-section-notes sheet-section">
            <div class="sheet-header">
                <span>NOTES</span>
            </div>

            <fieldset class="repeating_notes">
                <input class="sheet-options-flag sheet-hidden" type="checkbox" name="attr_options_flag" checked="checked" />
                <div class="sheet-item-options sheet-notes-edit">
                    <input class="sheet-item-options-flag" type="checkbox" name="attr_options_flag" checked="checked" />
                    <span>p</span>
                </div>
                <div class="sheet-options sheet-notes-row">
                    <input type="text" name="attr_title" placeholder="Notes Title" />
                    <textarea name="attr_body" placeholder="Notes"></textarea>
                </div>
                <div class="sheet-display sheet-notes-row">
                    <h3><span name="attr_title"></span></h3>
                    <span name="attr_body" class="sheet-keep-whitespace"></span>
                </div>
            </fieldset>

        </div>

        <div class="sheet-break"></div>

<!--SKILL ROLL SECTION: -->

<rolltemplate class="sheet-rolltemplate-skill">
    <div class="sheet-rollTemplate">
        <div class="row sheet-header">
            <span>Duality:</span>
            <span>{{name}}</span>
        </div>
        <div class="row">
            <div class="col">
                <div class="row">
                    <label>Boon</label>
                    <span>{{boon}}</span>
                </div>
                <div class="row">
                    <label>Dread</label>
                    <span>{{dread}}</span>
                </div>
                <div class="row">
                    <label>Results</label>
                    <span></span>
                </div>
            </div>
        </div>
     </div>
</div>
</rolltemplate>

<!--BONUS ROLL SECTION: DONE-->

<rolltemplate class="sheet-rolltemplate-bonuses">
    <div class="sheet-rollTemplate">
        <div class="row sheet-header">
            <span>Bonuses and Stunts</span>
            <span>: </span>
            <span>{{bonuses}}</span>
        </div>
        <div class="row">
            <span>{{description}}</span>
        </div>
    </div>
</rolltemplate>


<!--KEYWORD ROLL SECTION: DONE-->

<rolltemplate class="sheet-rolltemplate-keywords">
    <div class="sheet-rollTemplate">
        <div class="row sheet-header">
            <span>Keyword</span>
            <span>: </span>
            <span>{{keyword}}</span>
        </div>
        <div class="row">
            <span class="sheet-inlineLabel">Source</span>
            <span class="sheet-inlineLabel">: </span>
            <span>{{source}}</span>
        </div>
        <div class="row">
            <span>{{description}}</span>
        </div>
    </div>
</rolltemplate>


<!--SKILL ROLL SECTION:
    1. Make 2 similar columns to emulate advantage/disadvantage
    2. Implement rolls + modifier
-->


<!--WEAPONS ROLL SECTION
    1. Show weapon roll and damage when pressed
    2. Damage and Bonus does not show up auhhuhuh
    3. Have an option to set weapon to active/inactive and primary/secondary
-->

<rolltemplate class="sheet-rolltemplate-weapons">
    <div class="sheet-rollTemplate">
        <div class="row sheet-header">
            <span>Weapon</span>
            <span>: </span>
            <span>{{name}}</span>
        </div>
        <div class="row">
            <span class="sheet-inlineLabel">Trait</span>
            <span class="sheet-inlineLabel">: </span>
            <span>{{trait}}</span>
        </div>
        <div class="row">
            <span class="sheet-inlineLabel">Range</span>
            <span class="sheet-inlineLabel">: </span>
            <span>{{range}}</span>
        </div>
        <div class="row">
            <span class="sheet-inlineLabel">Type</span>
            <span class="sheet-inlineLabel">: </span>
            <span>{{type}}</span>
        </div>
        <div class="row">
            <span class="sheet-inlineLabel">Damage</span>
            <span class="sheet-inlineLabel">: </span>
            <span>{{damage}} + {{bonus}}</span>
        </div>
        <div class="row">
            <span>{{description}}</span>
        </div>
    </div>
</rolltemplate>

    
<script type="text/worker">
    on('sheet:opened', function () {
        getAttrs(["run_firstTime_setup", "default_stressSkills",
                    "default_consequences", "show_conditions_flag",
                    "importedOldData_flag"], function (values) {
            if (isNullOrWhitespace(values["importedOldData_flag"]))
            {
                ImportIdData();
                ImportSkills();
                ImportAspects();
                ImportStunts();
                ImportExtras();
                ImportStresses(values["run_firstTime_setup"], values["default_stressSkills"]);
                ImportConsequences(values["run_firstTime_setup"],
                    values["default_consequences"],
                    values["show_conditions_flag"]);
                ImportNotes();
    
                setAttrs({ importedOldData_flag: 1, run_firstTime_setup: 0 });
                return;
            }
            if (!isNullOrWhitespace(values["run_firstTime_setup"])) {
                SetDefaultStress(values["default_stressSkills"]);
                SetDefaultConsequences(values["default_consequences"], values["show_conditions_flag"]);
    
                setAttrs({ run_firstTime_setup: 0 });
            }
        });
    });
    
    function ImportIdData () {
        getAttrs(["Description", "Refresh", "Fate"], function (values) {
            if(isNullOrWhitespace(values["Description"])
                && isNullOrWhitespace(values["Refresh"]
                && isNullOrWhitespace(values["Fate"])))
                return;
    
            setAttrs({ character_description: values["Description"],
                        fatePoints_refresh: Number(values["Refresh"]),
                        fatepoints: Number(values["Fate"])
                     });
        });
    };
    
    
    function ImportAspects () {
        var attrs = [];
        attrs.push("HighConcept");
        attrs.push("Trouble");
        attrs.push("AdvantagesActive");
        for (var i = 1; i < 6; i++) {
            attrs.push("HiCon" + i);
            attrs.push("Trouble" + i);
        }
    
        getAttrs(attrs, function (values) {
            var hiCon = 0;
            var trbl = 0;
            for (var i = 1; i < 6; i++) {
                if (!isNullOrWhitespace(values["HiCon" + i]))
                    hiCon++;
                if (!isNullOrWhitespace(values["Trouble" + i]))
                    trbl++;
            }
    
            if (hiCon > 0)
                importSitAspect(values["HighConcept"], hiCon);
            if (trbl > 0)
                importSitAspect(values["Trouble"], trbl);
    
            if (isNullOrWhitespace(values["AdvantagesActive"]))
                return;
    
            getSectionIDs("repeating_Advantages", function (idArray) {
                if (idArray.length == 0)
                    return;
        
                idArray.forEach(id => {
                    var attrs = [];
                    attrs.push("repeating_Advantages_" + id + "_Advantages");
                    for (var i = 1; i < 6; i++) {
                        attrs.push("repeating_Advantages_" + id + "_Adv" + i);
                    }
        
                    getAttrs(attrs, function (values) {
                        var bonus = 0;
                        for (var i = 1; i < 6; i++) {
                            if (!isNullOrWhitespace(values["repeating_Advantages_" + id + "_Adv" + i]))
                                bonus++;
                        }
                
                        importSitAspect(values["repeating_Advantages_" + id + "_Advantages"], bonus);
                        removeRepeatingRow("repeating_Advantages_" + id);
                    });
                });
            });
        });
    
        getSectionIDs("repeating_Aspects", function (idArray) {
            if (idArray.length == 0)
                return;
    
            idArray.forEach(id => {
                var attrs = [];
                attrs.push("repeating_Aspects_" + id + "_Aspect");
                for (var i = 1; i < 6; i++) {
                    attrs.push("repeating_Aspects_" + id + "_Asp" + i);
                }
    
                getAttrs(attrs, function (values) {
                    var bonus = 0;
                    for (var i = 1; i < 6; i++) {
                        if (!isNullOrWhitespace(values["repeating_Aspects_" + id + "_Asp" + i]))
                            bonus++;
                    }
            
                    var index = idArray.indexOf(id);
                    if (index < 3) {
                        if (index == 0)
                            setAttrs({ aspect_one: values["repeating_Aspects_" + id + "_Aspect"]});
                        else if (index == 1)
                            setAttrs({ aspect_two: values["repeating_Aspects_" + id + "_Aspect"]});
                        else if (index == 2)
                            setAttrs({ aspect_three: values["repeating_Aspects_" + id + "_Aspect"]});
                        if (bonus > 0)
                            importSitAspect(values["repeating_Aspects_" + id + "_Aspect"], bonus);
                    }
                    else
                        importSitAspect(values["repeating_Aspects_" + id + "_Aspect"], bonus);
    
                    removeRepeatingRow("repeating_Aspects_" + id);
                });
            });
        });
    };
    
    const importSitAspect = (aspect, bonus) => {
        if (isNullOrWhitespace(aspect))
            return;
    
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_situationaspect_" + newRowId + "_aspect_name"] = aspect;
        newRowAttrs["repeating_situationaspect_" + newRowId + "_aspect_free_invokes"] = bonus;
        newRowAttrs["repeating_situationaspect_" + newRowId + "_options_flag"] = "on";
        setAttrs(newRowAttrs);
    };
    
    function ImportStunts () {
        getAttrs(["Stunts"], function (values) {
            getSectionIDs("repeating_Stunts", function (idArray) {
                importStunt(values["Stunts"]);
    
                if (idArray.length == 0)
                    return;
        
                var attrs = [];
                for (var i = 0; i < idArray.length; i++) {
                    attrs.push("repeating_Stunts_" + idArray[i] + "_Stunt");
                }
        
                getAttrs(attrs, function (stunts) {
                    for (var i = 0; i < idArray.length; i++) {
                        importStunt(stunts["repeating_Stunts_" + idArray[i] + "_Stunt"]);
                        removeRepeatingRow("repeating_Stunts_" + idArray[i]);
                    }
        
                    setAttrs(newRowAttrs);
                });
            });        
        });
    };
    
    const importStunt = (stunt) => {
        if (isNullOrWhitespace(stunt))
            return;
    
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_stunts_" + newRowId + "_description"] = stunt;
        setAttrs(newRowAttrs);
    };
    
    function ImportExtras () {
        getAttrs(["Extras"], function (values) {
            getSectionIDs("repeating_Extras", function (idArray) {
                importExtra(values["Extras"]);
    
                if (idArray.length == 0)
                    return;
        
                var attrs = [];
                for (var i = 0; i < idArray.length; i++) {
                    attrs.push("repeating_Extras_" + idArray[i] + "_Extra");
                }
        
                getAttrs(attrs, function (extras) {
                    for (var i = 0; i < idArray.length; i++) {
                        importExtra(extras["repeating_Extras_" + idArray[i] + "_Extra"]);
                        removeRepeatingRow("repeating_Extras_" + idArray[i]);
                    }
        
                    setAttrs(newRowAttrs);
                });
            });
        });
    };
    
    const importExtra = (extra) => {
        if (isNullOrWhitespace(extra))
            return;
    
        var newRowId = generateRowID();
        var newRowAttrs = {};
        newRowAttrs["repeating_extras_" + newRowId + "_description"] = extra;
        setAttrs(newRowAttrs);
    };
    
    function ImportStresses (runFirstTimeSetup, default_stressSkills) {
        var attr = [];
        attr.push("PhyGoverningSkill");
        attr.push("MenGoverningSkill");
        for (var i = 1; i < 5; i++) {
            attr.push("Phy" + i);
            attr.push("Phy" + i + "Active");
            attr.push("Men" + i);
            attr.push("Men" + i + "Active");
        }
        
        getAttrs(attr, function (basicValues) {
            var phyGoverningSkill = basicValues["PhyGoverningSkill"];
            if (isNullOrWhitespace(phyGoverningSkill))
                phyGoverningSkill = "Physique";
            
            var menGoverningSkill = basicValues["MenGoverningSkill"];
            if (isNullOrWhitespace(menGoverningSkill))
                menGoverningSkill = "Will";
            
            getSectionIDs("repeating_Stress", function (idArray) {
                if (idArray.length == 0) {
                    importStress("Physical", phyGoverningSkill, "Phy", basicValues);
                    importStress("Mental", menGoverningSkill, "Men", basicValues);
                        
                    if (!isNullOrWhitespace(runFirstTimeSetup))
                        SetDefaultStress(default_stressSkills);
    
                    return;
                }
            
                var attrs = [];
                idArray.forEach(id =>  {
                    attrs.push("repeating_Stress_" + id + "_Name");
                    attrs.push("repeating_Stress_" + id + "_Mirrored");
                    for (var x = 1; x < 5; x++) {
                        attr.push("repeating_Stress_" + id + "_Stress" + x);
                        attr.push("repeating_Stress_" + id + "_Stress" + x + "Active");
                    }
                });
    
                getAttrs(attrs, function (repValues) {
                    var mirrors = [];
                    for (var i = 0; i < idArray.length; i++) {
                        mirrors.push("repeating_StressOptions_" + repValues["repeating_Stress_" + idArray[i] + "_Mirrored"] + "_GoverningSkill");
                    }
        
                    getAttrs(mirrors, function (mirroredValues) {
                        importStress("Physical", phyGoverningSkill, "Phy", basicValues);
                        importStress("Mental", menGoverningSkill, "Men", basicValues);
    
                        idArray.forEach(id => {
                            importStress(repValues["repeating_Stress_" + id + "_Name"],
                                mirroredValues["repeating_StressOptions_" + repValues["repeating_Stress_" + id + "_Mirrored"] + "_GoverningSkill"],
                                "repeating_Stress_" + id + "_Stress", repValues);
                            
                            removeRepeatingRow("repeating_StressOptions_" + repValues["repeating_Stress_" + id + "_Mirrored"]);
                            removeRepeatingRow("repeating_Stress_" + id);
                        });
                        
                        if (!isNullOrWhitespace(runFirstTimeSetup))
                            SetDefaultStress(default_stressSkills);
                    });
                });
            });    
        });
    };
    
    const importStress = (stress, skill, prefix, attrs) => {
        var newRowAttrs = {};
        var stressMax = 0;
    
        var newRowId = generateRowID();
        newRowAttrs["repeating_stress_" + newRowId + "_name"] = stress.trim();
    
        for (var i = 1; i < 5; i++) {
            if(!isNullOrWhitespace(attrs[prefix + i + "Active"])) {
                stressMax++;
                if(!isNullOrWhitespace(attrs[prefix + i]))
                    newRowAttrs["repeating_stress_" + newRowId + "_isUsed" + i] = i;
            }
            else
                return;
        }
    
        if (stressMax == 0)
            return;
    
        newRowAttrs["repeating_stress_" + newRowId + "_usable"] = stressMax;
    
        if (!isNullOrWhitespace(skill)) {
            newRowAttrs["repeating_stress_" + newRowId + "_skill"] = skill.trim();
            newRowAttrs["repeating_stress_" + newRowId + "_bound"] = 1;
        }
    
        setAttrs(newRowAttrs);
    };
    
    function SetDefaultStress (default_stressSkills) {
        if (!isNullOrWhitespace(default_stressSkills)) {
            getSectionIDs("repeating_stress", function (idArray) {
                if (idArray.length == 0) {
                    var stressSkills = default_stressSkills.split(",");
                    var newRowAttrs = {};
                    stressSkills.forEach(element => {
                        var keyValuePair = element.split(":");
                        var newRowId = generateRowID();
                        newRowAttrs["repeating_stress_" + newRowId + "_name"] = keyValuePair[0].trim();
                        if (keyValuePair.length > 1) {
                            var skill = keyValuePair[1].trim();
                            var usable = Number(skill);
                            if (isNaN(usable)) {
                                newRowAttrs["repeating_stress_" + newRowId + "_skill"] = skill;
                                newRowAttrs["repeating_stress_" + newRowId + "_usable"] = 2;
                                newRowAttrs["repeating_stress_" + newRowId + "_bound"] = 1;
                            }
                            else {
                                newRowAttrs["repeating_stress_" + newRowId + "_usable"] = usable;
                                newRowAttrs["repeating_stress_" + newRowId + "_bound"] = 0;
                            }
                            newRowAttrs["repeating_stress_" + newRowId + "_options_flag"] = 0;
                        }
                        else {
                            newRowAttrs["repeating_stress_" + newRowId + "_options_flag"] = "on";
                        }
                    });
                    setAttrs(newRowAttrs);
                }
            });
        }
    };
    
    function ImportConsequences (runFirstTimeSetup, default_consequences, show_conditions_flag) {
        var attr = [];
        attr.push("MildConsequence");
        attr.push("MildInvoke");
        attr.push("ModerateConsequence");
        attr.push("ModerateInvoke");
        attr.push("SevereConsequence");
        attr.push("SevereInvoke");
        
        getAttrs(attr, function (basicValues) {
            getSectionIDs("repeating_Cons", function (idArray) {
                if (idArray.length == 0) {
                    if (isNullOrWhitespace(basicValues["MildConsequence"])
                        && isNullOrWhitespace(basicValues["MildInvoke"])
                        && isNullOrWhitespace(basicValues["ModerateConsequence"])
                        && isNullOrWhitespace(basicValues["ModerateInvoke"])
                        && isNullOrWhitespace(basicValues["SevereConsequence"])
                        && isNullOrWhitespace(basicValues["SevereInvoke"])) {
                            if (!isNullOrWhitespace(runFirstTimeSetup))
                                SetDefaultConsequences(default_consequences, show_conditions_flag);
                            return;
                        }
                    
                    importConsequence(2, basicValues["MildConsequence"], !isNullOrWhitespace(basicValues["MildInvoke"]));
                    importConsequence(4, basicValues["ModerateConsequence"], !isNullOrWhitespace(basicValues["ModerateInvoke"]));
                    importConsequence(6, basicValues["SevereConsequence"], !isNullOrWhitespace(basicValues["SevereInvoke"]));
                    return;
                }
            
                var attrs = [];
                for (var i = 0; i < idArray.length; i++) {
                    attrs.push("repeating_Cons_" + idArray[i] + "_conType");
                    attrs.push("repeating_Cons_" + idArray[i] + "_Consequence");
                    attrs.push("repeating_Cons_" + idArray[i] + "_Invoke");
                }
    
                getAttrs(attrs, function (repValues) {
                    importConsequence(2, basicValues["MildConsequence"], !isNullOrWhitespace(basicValues["MildInvoke"]));
                    importConsequence(4, basicValues["ModerateConsequence"], !isNullOrWhitespace(basicValues["ModerateInvoke"]));
                    importConsequence(6, basicValues["SevereConsequence"], !isNullOrWhitespace(basicValues["SevereInvoke"]));
    
                    for (var i = 0; i < idArray.length; i++) {
                        var worth = 0;
                        switch (repValues["repeating_Cons_" + idArray[i] + "_conType"]) {
                            case "Mild":
                                worth = 2;
                                break;
                            case "Moderate":
                                worth = 4;
                                break;
                            case "Severe":
                                worth = 6;
                                break;
                        }
                    
                        importConsequence(worth,
                            repValues["repeating_Cons_" + idArray[i] + "_Consequence"],
                            !isNullOrWhitespace(repValues["repeating_Cons_" + idArray[i] + "_Invoke"]));
                        
                        removeRepeatingRow("repeating_Cons_" + idArray[i]);
                    }
                });
            });    
        });
    };
    
    const importConsequence = (worth, aspect, addBonus) => {
        if (!isNaN(worth) && worth > 0) {
            var newRowAttrs = {};
            var newRowId = generateRowID();
            newRowAttrs["repeating_consequences_" + newRowId + "_worth"] = worth;
            newRowAttrs["repeating_consequences_" + newRowId + "_aspect"] = aspect;
            newRowAttrs["repeating_consequences_" + newRowId + "_worth_text"] = getConsequenceText(worth);
    
            setAttrs(newRowAttrs);
    
            if (addBonus)
                importSitAspect(aspect, 1);
        }
    };
    
    function SetDefaultConsequences (default_consequences, show_conditions_flag) {
        if (!isNullOrWhitespace(default_consequences)) {
            getSectionIDs("repeating_consequences", function (idArray) {
                if (idArray.length == 0) {
                    var consequences = default_consequences.split(",")
                    var newRowAttrs = {};
                    consequences.forEach(consequence => {
                        var elements = consequence.split("|");
                        var worth = Number(elements[0].trim());
                        if (!isNaN(worth) && worth > 0) {
                            var newRowId = generateRowID();
                            newRowAttrs["repeating_consequences_" + newRowId + "_worth"] = worth;
    
                            if (elements.length > 1)
                                newRowAttrs["repeating_consequences_" + newRowId + "_aspect"] = elements[1];
                            if (show_conditions_flag == "1")
                                newRowAttrs["repeating_consequences_" + newRowId + "_worth_text"] = getConditionsText(worth);
                            else
                                newRowAttrs["repeating_consequences_" + newRowId + "_worth_text"] = getConsequenceText(worth);
                        }
                    });
                    setAttrs(newRowAttrs);
                }
            });
        }
    };
    
    function ImportNotes () {
        getAttrs(["Notes"], function (values) {
            if(isNullOrWhitespace(values["Notes"]))
                return;
    
            var newRowAttrs = {};
            var newRowId = generateRowID();
            newRowAttrs["repeating_notes_" + newRowId + "_body"] = values["Notes"];
    
            setAttrs(newRowAttrs);
        });
    };
    
    
    function getConsequenceText(worth) {
        switch (Number(worth)) {
            case 2:
                return "Mild";
            case 4:
                return "Moderate";
            case 6:
                return "Severe";
            case 8:
                return "Extreme";
            default:
                return "Custom";
        }
    };
    
    function getConditionsText(worth) {
        switch (Number(worth)) {
            case 1:
                return "Fleeting";
            case 2:
                return "Sticky";
            case 4:
                return "Lasting";
            default:
                return "Custom";
        }
    };
    
    function getStressMax(skillShiftLevel) {
        if (skillShiftLevel < 1) {
            return 2;
        }
    
        if (skillShiftLevel < 3) {
            return 3;
        }
    
        return 4;
    };
    
    const isNullOrWhitespace = (attr) => !(attr && (attr.trim ? attr.trim() && attr.trim() != "0" : attr > 0));
</script>



